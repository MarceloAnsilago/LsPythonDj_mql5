{% extends "_base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block extra_head %}
<style>
  .asset-logo-inline {
    width: 52px;
    height: 52px;
    min-width: 52px;
    border-radius: 16px;
    border: 1px solid rgba(15, 23, 42, 0.08);
    background: linear-gradient(135deg, #eef2ff, #fdf2f8);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    font-size: 0.65rem;
    color: #0f172a;
    position: relative;
    overflow: hidden;
  }

  .asset-logo-inline img {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: inherit;
  }
</style>
{% endblock %}

{% block content %}
<div class="d-flex align-items-center gap-3 mb-3">
  {% if view.object and view.object.ticker %}
    <div class="asset-logo-inline" aria-label="{{ view.object.name }} logo">
      <img src="https://raw.githubusercontent.com/thefintz/icones-b3/main/icones/{{ view.object.ticker|upper }}.png"
           alt="{{ view.object.ticker }} logo"
           loading="lazy"
           onerror="this.remove();">
      <span>{{ view.object.ticker }}</span>
    </div>
  {% else %}
    <div class="asset-logo-inline" aria-hidden="true">
      <span>LOGO</span>
    </div>
  {% endif %}
  <h2 class="mb-0">{{ view.object|yesno:"Editar Ativo,Novo Ativo" }}</h2>
</div>

<form method="post" class="card p-3 p-md-4 shadow-sm rounded-3">
  {% csrf_token %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  <div class="row g-3">
    <div class="col-12 col-md-4">
      <label class="form-label" for="{{ form.ticker.id_for_label }}">Ticker</label>
      {{ form.ticker|add_class:"form-control text-uppercase" }}
      {{ form.ticker.errors }}
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label" for="{{ form.ticker_yf.id_for_label }}">Yahoo Finance</label>
      {{ form.ticker_yf|add_class:"form-control text-uppercase" }}
      <div class="form-text">Adiciona <code>.SA</code> automaticamente quando necess√°rio.</div>
      {{ form.ticker_yf.errors }}
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label" for="{{ form.name.id_for_label }}">Nome</label>
      {{ form.name|add_class:"form-control" }}
      {{ form.name.errors }}
    </div>

    <div class="col-12 d-flex align-items-center gap-3">
      <div class="form-check">
        {{ form.is_active|add_class:"form-check-input" }}
        <label class="form-check-label ms-1" for="{{ form.is_active.id_for_label }}">Ativa</label>
      </div>
      {{ form.is_active.errors }}
    </div>
  </div>

  <div class="d-flex gap-2 mt-4">
    <button class="btn btn-primary">Salvar</button>
    <a class="btn btn-outline-secondary" href="{% url 'acoes:lista' %}">Cancelar</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  const fTicker = document.getElementById('id_ticker');
  const fYF = document.getElementById('id_ticker_yf');

  function ensureYFFormat() {
    if (!fYF) return;
    let yf = (fYF.value || '').toUpperCase().trim();
    if (!yf && fTicker?.value) {
      yf = fTicker.value.toUpperCase().trim();
    }
    if (yf && !yf.includes('.')) {
      yf = `${yf}.SA`;
    }
    fYF.value = yf;
  }

  if (fTicker) {
    fTicker.addEventListener('input', function () {
      this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
    fTicker.addEventListener('blur', ensureYFFormat);
  }

  if (fYF) {
    fYF.addEventListener('blur', function () {
      fYF.value = fYF.value.toUpperCase().trim();
      ensureYFFormat();
    });
  }
})();
</script>
{% endblock %}
